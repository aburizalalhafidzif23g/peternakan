<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Riwayat Ternak</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showFilterModal()">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Search Bar -->
  <ion-toolbar>
    <ion-searchbar 
      placeholder="Cari berdasarkan eartag atau nama pemilik..."
      [(ngModel)]="searchTerm"
      (ionInput)="onSearch()"
      animated>
    </ion-searchbar>
  </ion-toolbar>

  <!-- Filter Tabs -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="filterStatus" (ionChange)="onFilterChange()">
      <ion-segment-button value="semua">
        <ion-label>Semua</ion-label>
      </ion-segment-button>
      <ion-segment-button value="ib">
        <ion-label>IB Saja</ion-label>
      </ion-segment-button>
      <ion-segment-button value="pkb">
        <ion-label>PKB</ion-label>
      </ion-segment-button>
      <ion-segment-button value="lahir">
        <ion-label>Lahiran</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="riwayat-container">

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredRiwayat.length === 0">
      <ion-icon name="document-text-outline"></ion-icon>
      <h3>Tidak Ada Data</h3>
      <p>Belum ada riwayat ternak yang tercatat</p>
    </div>

    <!-- List Riwayat -->
    <ion-card class="riwayat-card" *ngFor="let item of filteredRiwayat" (click)="openDetail(item)">
      
      <!-- Card Header -->
      <div class="card-header">
        <div class="header-left">
          <ion-icon [name]="item.jenisTernak === 'Sapi' ? 'paw' : 'leaf'" class="animal-icon"></ion-icon>
          <div>
            <h3>{{ item.eartagBetina }}</h3>
            <p>{{ item.jenisTernak }} - {{ item.rumpunTernak }}</p>
          </div>
        </div>
        <ion-badge [color]="getStatusColor(item.status)" class="status-badge">
          {{ item.status }}
        </ion-badge>
      </div>

      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-step" [class.active]="item.hasIB" [class.completed]="item.hasIB">
            <div class="step-circle">
              <ion-icon name="medical-outline" *ngIf="!item.hasIB"></ion-icon>
              <ion-icon name="checkmark" *ngIf="item.hasIB"></ion-icon>
            </div>
            <span class="step-label">IB</span>
          </div>

          <div class="progress-line" [class.active]="item.hasPKB"></div>

          <div class="progress-step" [class.active]="item.hasPKB" [class.completed]="item.hasPKB">
            <div class="step-circle">
              <ion-icon name="clipboard-outline" *ngIf="!item.hasPKB"></ion-icon>
              <ion-icon name="checkmark" *ngIf="item.hasPKB"></ion-icon>
            </div>
            <span class="step-label">PKB</span>
          </div>

          <div class="progress-line" [class.active]="item.hasLahir"></div>

          <div class="progress-step" [class.active]="item.hasLahir" [class.completed]="item.hasLahir">
            <div class="step-circle">
              <ion-icon name="heart-outline" *ngIf="!item.hasLahir"></ion-icon>
              <ion-icon name="checkmark" *ngIf="item.hasLahir"></ion-icon>
            </div>
            <span class="step-label">Lahir</span>
          </div>
        </div>
      </div>

      <!-- Card Info -->
      <ion-card-content>
        <div class="info-row">
          <ion-icon name="person-outline"></ion-icon>
          <span>{{ item.namaPemilik }}</span>
        </div>

        <div class="info-row">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ item.desa }}, {{ item.kecamatan }}</span>
        </div>

        <div class="info-row" *ngIf="item.tanggalIB">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>IB: {{ item.tanggalIB | date: 'dd MMM yyyy' }}</span>
        </div>

        <div class="info-row" *ngIf="item.tanggalPKB">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>PKB: {{ item.tanggalPKB | date: 'dd MMM yyyy' }}</span>
        </div>

        <div class="info-row" *ngIf="item.prediksiLahir">
          <ion-icon name="time-outline"></ion-icon>
          <span>Prediksi Lahir: {{ item.prediksiLahir | date: 'dd MMM yyyy' }}</span>
        </div>

        <div class="info-row" *ngIf="item.tanggalLahir">
          <ion-icon name="gift-outline"></ion-icon>
          <span>Lahir: {{ item.tanggalLahir | date: 'dd MMM yyyy' }}</span>
        </div>

        <!-- Petugas Info -->
        <div class="petugas-info">
          <ion-icon name="shield-checkmark-outline"></ion-icon>
          <span>Petugas: {{ item.namaPetugas }}</span>
        </div>
      </ion-card-content>

      <!-- Card Footer Actions -->
      <div class="card-footer">
        <ion-button 
          fill="clear" 
          size="small" 
          (click)="viewPhoto(item, $event)"
          *ngIf="item.foto">
          <ion-icon slot="start" name="image-outline"></ion-icon>
          Lihat Foto
        </ion-button>

        <ion-button 
          fill="clear" 
          size="small" 
          color="success"
          (click)="updateProgress(item, $event)"
          *ngIf="!item.hasLahir">
          <ion-icon slot="start" name="add-circle-outline"></ion-icon>
          {{ item.hasPKB ? 'Input Lahiran' : 'Input PKB' }}
        </ion-button>

        <ion-button 
          fill="clear" 
          size="small" 
          color="medium"
          (click)="openDetail(item, $event)">
          <ion-icon slot="start" name="information-circle-outline"></ion-icon>
          Detail
        </ion-button>
      </div>
    </ion-card>

  </div>

  <!-- Floating Action Button -->
  <!-- <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="primary" (click)="goToInputIB()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab> -->

</ion-content>